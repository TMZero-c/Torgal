<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Live Transcriber</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
</head>

<body>
    <h1>Live Transcriber</h1>
    <button id="btn">Start</button>
    <span id="status"></span>
    <hr>
    <div id="transcript"></div>
    <p id="partial"><i></i></p>

    <script>
        const btn = document.getElementById('btn');
        const status = document.getElementById('status');
        const transcript = document.getElementById('transcript');
        const partial = document.getElementById('partial').querySelector('i');

        let audioContext, processor, source, stream;
        let isListening = false;

        window.api.onTranscript(msg => {
            if (msg.type === 'ready') {
                status.textContent = 'Ready';
            } else if (msg.type === 'partial') {
                partial.textContent = msg.text;
            } else if (msg.type === 'final') {
                partial.textContent = '';
                transcript.textContent += msg.text + ' ';
                transcript.scrollTop = transcript.scrollHeight;
            }
        });

        async function startListening() {
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioContext = new AudioContext({ sampleRate: 16000 });
            source = audioContext.createMediaStreamSource(stream);

            // Process audio in chunks
            processor = audioContext.createScriptProcessor(4096, 1, 1);
            processor.onaudioprocess = (e) => {
                const float32 = e.inputBuffer.getChannelData(0);
                // Convert to 16-bit PCM
                const int16 = new Int16Array(float32.length);
                for (let i = 0; i < float32.length; i++) {
                    int16[i] = Math.max(-32768, Math.min(32767, float32[i] * 32768));
                }
                // Send as base64
                const bytes = new Uint8Array(int16.buffer);
                const base64 = btoa(String.fromCharCode(...bytes));
                window.api.sendAudioChunk(base64);
            };

            source.connect(processor);
            processor.connect(audioContext.destination);
            isListening = true;
            status.textContent = 'Listening...';
            btn.textContent = 'Stop';
        }

        function stopListening() {
            if (processor) processor.disconnect();
            if (source) source.disconnect();
            if (audioContext) audioContext.close();
            if (stream) stream.getTracks().forEach(t => t.stop());
            isListening = false;
            status.textContent = 'Stopped';
            btn.textContent = 'Start';
            window.api.reset();
        }

        btn.onclick = () => isListening ? stopListening() : startListening();
    </script>
</body>

</html>