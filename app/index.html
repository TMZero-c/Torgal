<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slide Co-Pilot</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
        h1 { font-size: 22px; margin-bottom: 4px; }
        .subtitle { color: #666; margin-bottom: 16px; font-size: 13px; }
        
        /* Upload section */
        #upload { margin-bottom: 16px; display: flex; gap: 12px; align-items: center; }
        #upload-btn { padding: 8px 16px; cursor: pointer; }
        #file-status { color: #666; font-size: 13px; }
        
        /* Slide viewer */
        #slide-viewer { display: none; margin-bottom: 16px; background: #000; border-radius: 8px; overflow: hidden; }
        #slide-image { width: 100%; display: block; }
        #slide-nav-bar { display: flex; justify-content: center; align-items: center; gap: 12px; padding: 10px; background: #222; color: white; }
        #slide-nav-bar button { padding: 6px 12px; cursor: pointer; }
        #slide-counter { font-size: 13px; }
        
        /* Controls */
        #controls { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        #btn { padding: 10px 20px; font-size: 15px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 4px; }
        #btn.on { background: #e53935; }
        #status { color: #666; font-size: 13px; }
        
        /* Transcript */
        #transcript { background: #f5f5f5; padding: 12px; border-radius: 4px; min-height: 60px; max-height: 100px; overflow-y: auto; font-size: 14px; }
        #partial { color: #888; font-style: italic; margin-top: 4px; font-size: 13px; }
        
        /* Info bar */
        #info { margin-top: 12px; padding: 10px; background: #e3f2fd; border-radius: 4px; border-left: 3px solid #2196F3; font-size: 13px; }
        #info.triggered { background: #c8e6c9; border-color: #4CAF50; }
    </style>
</head>
<body>
    <h1>üéØ Slide Co-Pilot</h1>
    <p class="subtitle">Upload a presentation, then speak - slides auto-transition based on your content</p>
    
    <div id="upload">
        <button id="upload-btn">üìÅ Upload Presentation (PDF/PPTX)</button>
        <span id="file-status">No file loaded</span>
    </div>
    
    <div id="slide-viewer">
        <img id="slide-image" src="">
        <div id="slide-nav-bar">
            <button id="prev-btn">‚Üê Prev</button>
            <span id="slide-counter">Slide 1 of 1</span>
            <button id="next-btn">Next ‚Üí</button>
        </div>
    </div>
    
    <div id="controls">
        <button id="btn">Start Listening</button>
        <span id="status">Load a presentation first</span>
    </div>
    
    <div id="transcript"></div>
    <div id="partial"></div>
    <div id="info">Waiting...</div>

    <script>
        const $ = id => document.getElementById(id);
        let slides = [], current = 0, listening = false;
        let audioCtx, processor, source, stream;

        // Update slide display
        function showSlide(i) {
            if (!slides.length) return;
            current = i;
            $('slide-image').src = slides[i].image;
            $('slide-counter').textContent = `Slide ${i + 1} of ${slides.length}`;
        }

        // File upload
        $('upload-btn').onclick = async () => {
            const path = await window.api.openFileDialog();
            if (path) $('file-status').textContent = 'Loading...';
        };

        window.api.onSlidesLoaded(data => {
            if (data.status === 'success') {
                slides = data.slides;
                current = 0;
                showSlide(0);
                $('slide-viewer').style.display = 'block';
                $('file-status').textContent = `Loaded ${data.total_pages} slides`;
                $('status').textContent = 'Ready - click Start';
            } else {
                $('file-status').textContent = `Error: ${data.message}`;
            }
        });

        $('prev-btn').onclick = () => current > 0 && showSlide(current - 1);
        $('next-btn').onclick = () => current < slides.length - 1 && showSlide(current + 1);

        // Transcript handling
        window.api.onTranscript(msg => {
            if (msg.type === 'ready') {
                $('status').textContent = 'Ready';
            }
            else if (msg.type === 'final') {
                $('transcript').textContent += msg.text + ' ';
                $('transcript').scrollTop = $('transcript').scrollHeight;
            }
            else if (msg.type === 'partial') {
                $('partial').textContent = msg.text;
            }
            else if (msg.type === 'slide_transition') {
                showSlide(msg.to_slide);
                $('info').className = 'triggered';
                $('info').textContent = `‚Üí Slide ${msg.to_slide + 1}: ${msg.slide_title} (${(msg.confidence * 100).toFixed(0)}%)`;
                setTimeout(() => $('info').className = '', 1000);
            }
            else if (msg.type === 'reset_done') {
                showSlide(0);
                $('transcript').textContent = '';
                $('info').textContent = 'Reset';
            }
        });

        // Audio capture
        async function start() {
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioCtx = new AudioContext({ sampleRate: 16000 });
            source = audioCtx.createMediaStreamSource(stream);
            processor = audioCtx.createScriptProcessor(4096, 1, 1);
            processor.onaudioprocess = e => {
                const f32 = e.inputBuffer.getChannelData(0);
                const i16 = new Int16Array(f32.length);
                for (let i = 0; i < f32.length; i++) i16[i] = Math.max(-32768, Math.min(32767, f32[i] * 32768));
                window.api.sendAudioChunk(btoa(String.fromCharCode(...new Uint8Array(i16.buffer))));
            };
            source.connect(processor);
            processor.connect(audioCtx.destination);
            listening = true;
            $('btn').textContent = 'Stop';
            $('btn').className = 'on';
            $('status').textContent = 'Listening...';
        }

        function stop() {
            processor?.disconnect(); source?.disconnect(); audioCtx?.close();
            stream?.getTracks().forEach(t => t.stop());
            listening = false;
            $('btn').textContent = 'Start Listening';
            $('btn').className = '';
            $('status').textContent = 'Stopped';
            window.api.reset();
        }

        $('btn').onclick = () => listening ? stop() : start();
    </script>
</body>
</html>
